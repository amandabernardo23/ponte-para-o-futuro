<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ponte para o Futuro - Perfil</title>
<link rel="stylesheet" href="../instituicao.css" />
<script src="aluno.js" defer></script>
</head>
<body>
  <div class="dashboard">
    <aside class="sidebar">
<!-- insere a foto de perfil do usu√°rio -->
     <form id="foto-form" enctype="multipart/form-data">
  <div class="upload-container">
    <label for="foto-input" class="upload-label">
      <img id="preview-img" class="profile-pic" src="http://localhost:3000/uploads/usuario-123.jpg" alt="">
      <span class="icon-overlay">üì∑</span>
    </label>
    <input type="file" id="foto-input" name="foto" accept="image/*" hidden>
  </div>
  <!-- Modal flutuante central -->
<div id="foto-modal" class="modal hidden">
  <div class="modal-content">
    <p>Deseja salvar a nova foto de perfil?</p>
    <div class="modal-buttons">
      <button id="confirmar-btn" class="btn salvar">Salvar</button>
      <button id="cancelar-btn" class="btn cancelar">Cancelar</button>
    </div>
  </div>
</div>

</form>

<!-- insere a foto de perfil do usu√°rio -->
      <p class="institution-name"></p>
       <button onclick="mostrarSecao('meu-perfil')">Meu Perfil</button>
       <button onclick="mostrarSecao('mentoria')">Mentoria</button>
       <button onclick="mostrarSecao('projetos-disponiveis')">Projetos Dispon√≠veis</button>
       <button onclick="mostrarSecao('meus-projetos')">Meus Projetos</button>
      <a href="/login.html" class="back-button"> Sair </a>
    </aside>

     <main class="main-content">
      <!-- Painel Inicial -->
      <section id="meu-perfil" class="secao-dashboard active">
        <h2>Bem-vindo(a) </h2>
        <h2>Meu Perfil</h2>
        <div class="dashboard-cards">
        </div>
      </section>

     <section id="mentoria" class="secao-dashboard">
          <div class="mentoria-card">
            <div><strong>üìÖ HOJE - 15h00</strong></div>
            <div>
              <strong
                >Painel de Indicadores de Efici√™ncia Operacional (PIEO)</strong
              >
            </div>
            <p>Apresenta√ß√£o do m√≥dulo de dashboards + gr√°ficos</p>
            <button class="btn-azul">Acessar chamada</button>
          </div>
            <button class="btn-azul">Agendar reuni√£o</button>
      </section> 

      <section id="projetos-disponiveis" class="secao-dashboard">
        <h2>Projetos Dispon√≠veis</h2>
        <table border="1">
          <thead>
            <tr>
              <th>  Id  </th>
              <th>  T√≠tulo  </th>
              <th>  Descri√ß√£o  </th>
              <th>  Status  </th>
              <th>  Data In√≠cio  </th>
              <th>  Data T√©rmino  </th>
            </tr>
          </thead>
          <tbody id="tabela-projetos">
          <!-- Conte√∫do ser√° preenchido via JavaScript -->
          </tbody>
          </table>
      </section>

      <section id="meus-projetos" class="secao-dashboard">
        <h2>Meus Projetos</h2>
        <table border="1">
          <thead>
            <tr><th>T√≠tulo</th><th>Descri√ß√£o</th><th>Status</th><th>Mensagem</th></tr>
          </thead>
          <tbody id="tabela-meus-projetos">
            <!-- Carregado via JS -->
          </tbody>
        </table>
      </section>
    </main>

 <script>
  document.addEventListener("DOMContentLoaded", () => {
    const dados = localStorage.getItem("usuarioLogado");

    if (dados) {
      const usuario = JSON.parse(dados);

      // Verifica se o tipo de usu√°rio est√° correto
      if (usuario.tipo !== "aluno") {
        alert("Acesso n√£o autorizado.");
        window.location.href = "login.html";
        return;
      }

      // Atualiza nome do usu√°rio no menu lateral
      const nomeElemento = document.querySelector('.institution-name');
      if (nomeElemento) {
        nomeElemento.textContent = usuario.nome || "Aluno";
      }

      // Atualiza t√≠tulo principal
      const tituloPrincipal = document.querySelector('#meu-perfil h2');
      if (tituloPrincipal) {
        tituloPrincipal.textContent = `Bem-vindo(a), ${usuario.nome || "Aluno"}!`;
      }

      // Atualiza a foto de perfil (se existir)
      if (usuario.fotoPerfil) {
        const imgEl = document.getElementById('preview-img');
        if (imgEl) imgEl.src = `/uploads/${usuario.fotoPerfil}`;
      }

    } else {
      // Redireciona se n√£o estiver logado
      window.location.href = "login.html";
    }
  });
</script>

<Script>
function mostrarSecao(secaoId) {
  const secoes = document.querySelectorAll('.secao-dashboard');
  secoes.forEach(secao => secao.classList.remove('active'));

  const secaoSelecionada = document.getElementById(secaoId);
  if (secaoSelecionada) {
    secaoSelecionada.classList.add('active');
  }

  // Executa fun√ß√µes de carregamento com base na se√ß√£o
  if (secaoId === 'projetos-disponiveis') {
    carregarProjetos();
  }
  if (secaoId === 'meus-projetos') {
    carregarMeusProjetos();
  }
}
</Script>

<script>
  const fotoInput = document.getElementById('foto-input');
  const previewImg = document.getElementById('preview-img');
  const modal = document.getElementById('foto-modal');
  const confirmarBtn = document.getElementById('confirmar-btn');
  const cancelarBtn = document.getElementById('cancelar-btn');
  let novaImagem = null;

  fotoInput.addEventListener('change', () => {
    const file = fotoInput.files[0];
    if (file) {
      novaImagem = file;
      const reader = new FileReader();
      reader.onload = e => {
        previewImg.src = e.target.result;
        modal.classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    }
  });

  confirmarBtn.addEventListener('click', async () => {
    if (!novaImagem) return;

    const formData = new FormData();
    formData.append('foto', novaImagem);

    const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
    if (!usuarioLogado || !usuarioLogado.id) {
      alert('Usu√°rio n√£o identificado. Fa√ßa login novamente.');
      return;
    }
    formData.append('userId', usuarioLogado.id);

    try {
      const res = await fetch('http://localhost:3000/upload-foto', {
        method: 'POST',
        body: formData
      });

      const data = await res.json();

      if (data.caminho) {
        previewImg.src = `/uploads/${data.caminho}`;
        usuarioLogado.fotoPerfil = data.caminho;
        localStorage.setItem('usuarioLogado', JSON.stringify(usuarioLogado));
      }

      alert(data.message || 'Foto enviada com sucesso!');
      modal.classList.add('hidden');
      fotoInput.value = '';
      novaImagem = null;
    } catch (error) {
      alert('Erro ao enviar a foto. Tente novamente.');
      console.error(error);
    }
  });

  cancelarBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
    novaImagem = null;
    fotoInput.value = '';
  });
</script>
</body>
</html>